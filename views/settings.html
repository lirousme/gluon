<!-- 
  Arquivo: settings.html
  Diretório: public_html/gluon/views/settings.html
  
  Pilar: Fácil Manutenção, Bonito, Seguro e Rápido.
  Lógica assíncrona ultra rápida para lidar com atualização, logout e exclusão de contas,
  exigindo senha de validação em passos críticos para segurança.
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gluon - Configurações da Conta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gluon: { dark: '#0f172a', primary: '#3b82f6', secondary: '#1e293b', accent: '#6366f1' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gluon-dark text-slate-200 h-screen flex flex-col font-sans selection:bg-gluon-primary selection:text-white overflow-y-auto">

    <!-- Top Navigation -->
    <nav class="bg-gluon-secondary border-b border-slate-700/50 shrink-0 z-40 backdrop-blur-md bg-opacity-90 sticky top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-slate-800 border border-slate-600 flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-user-gear text-xl text-gluon-primary"></i>
                </div>
                <span class="font-bold text-lg sm:text-xl tracking-wide text-white">Configurações</span>
            </div>
            
            <button onclick="window.location.href='/dashboard'" class="text-sm bg-slate-800 border border-slate-600 text-slate-300 hover:text-white hover:bg-slate-700 px-4 py-2 rounded-lg transition-colors flex items-center gap-2 font-medium shadow-sm">
                <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">Voltar ao Workspace</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 w-full max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
        
        <!-- Form: Atualizar Dados -->
        <div class="bg-gluon-secondary border border-slate-700 rounded-xl shadow-xl overflow-hidden mb-8">
            <div class="px-6 py-5 border-b border-slate-700 bg-slate-800/50">
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                    <i class="fa-solid fa-id-card text-gluon-primary"></i> Editar Perfil
                </h2>
                <p class="text-sm text-slate-400 mt-1">Atualize suas informações básicas e credenciais de acesso.</p>
            </div>
            
            <form id="profileForm" class="p-6 space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1" for="username">Nome de Usuário</label>
                        <div class="relative">
                            <i class="fa-solid fa-at absolute left-3 top-3 text-slate-500"></i>
                            <input type="text" id="username" required class="w-full pl-9 pr-3 py-2.5 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-gluon-primary focus:ring-1 focus:ring-gluon-primary transition-colors">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1" for="email">E-mail</label>
                        <div class="relative">
                            <i class="fa-solid fa-envelope absolute left-3 top-3 text-slate-500"></i>
                            <input type="email" id="email" required class="w-full pl-9 pr-3 py-2.5 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-gluon-primary focus:ring-1 focus:ring-gluon-primary transition-colors">
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-700 pt-6">
                    <h3 class="text-sm font-semibold text-slate-300 mb-4 uppercase tracking-wider">Segurança</h3>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1" for="new_password">Nova Senha (Opcional)</label>
                            <input type="password" id="new_password" class="w-full px-3 py-2.5 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-gluon-primary focus:ring-1 focus:ring-gluon-primary transition-colors" placeholder="Deixe em branco para manter">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-amber-400 mb-1" for="current_password">Senha Atual (Obrigatória)</label>
                            <input type="password" id="current_password" required class="w-full px-3 py-2.5 bg-slate-800 border border-amber-500/50 rounded-lg text-white focus:outline-none focus:border-amber-400 focus:ring-1 focus:ring-amber-400 transition-colors placeholder-slate-500" placeholder="Digite para salvar as alterações">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-2">
                    <button type="submit" id="btnSaveProfile" class="bg-gluon-primary hover:bg-blue-600 text-white font-medium py-2.5 px-6 rounded-lg shadow-lg hover:shadow-blue-500/30 transition-all flex items-center gap-2">
                        <i class="fa-solid fa-floppy-disk"></i> <span>Salvar Alterações</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Zona de Perigo -->
        <div class="bg-red-900/10 border border-red-900/50 rounded-xl overflow-hidden shadow-xl">
            <div class="px-6 py-5 border-b border-red-900/50 bg-red-900/20">
                <h2 class="text-lg font-semibold text-red-400 flex items-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation"></i> Zona de Perigo
                </h2>
            </div>
            <div class="p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                
                <div class="flex-1 w-full">
                    <h3 class="font-medium text-slate-200 mb-1">Encerrar Sessão</h3>
                    <p class="text-sm text-slate-400">Desconectar deste dispositivo e limpar cookies.</p>
                </div>
                <button onclick="app.logout()" id="btnLogout" class="w-full sm:w-auto bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white font-medium py-2 px-5 rounded-lg transition-all flex items-center justify-center gap-2 whitespace-nowrap">
                    <i class="fa-solid fa-power-off text-slate-400"></i> Sair da Conta
                </button>

            </div>
            
            <div class="p-6 border-t border-red-900/30 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-red-950/20">
                <div class="flex-1 w-full">
                    <h3 class="font-medium text-red-400 mb-1">Excluir Conta Permanentemente</h3>
                    <p class="text-sm text-slate-400 leading-relaxed">Atenção: Todos os seus diretórios, configurações e dados criptografados serão excluídos do servidor sem chance de recuperação.</p>
                </div>
                <button onclick="app.openDeleteModal()" class="w-full sm:w-auto bg-red-600 hover:bg-red-500 text-white font-medium py-2 px-5 rounded-lg shadow-lg hover:shadow-red-500/30 transition-all flex items-center justify-center gap-2 whitespace-nowrap">
                    <i class="fa-solid fa-trash"></i> Excluir Conta
                </button>
            </div>
        </div>

    </main>

    <!-- Modal: Excluir Conta -->
    <div id="deleteModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 opacity-0 transition-opacity duration-300 px-4">
        <div class="bg-gluon-secondary border border-red-900 rounded-xl shadow-2xl w-full max-w-md p-6 transform scale-95 transition-transform duration-300" id="deleteModalContent">
            
            <div class="text-center mb-6">
                <div class="w-16 h-16 rounded-full bg-red-500/10 border border-red-500/20 flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-skull-crossbones text-3xl text-red-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Você tem certeza absoluta?</h3>
                <p class="text-sm text-slate-400">Esta ação não pode ser desfeita. Para confirmar a exclusão, digite sua senha atual.</p>
            </div>

            <form id="deleteForm" onsubmit="app.deleteAccount(event)">
                <div class="mb-6">
                    <input type="password" id="delete_password" required class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-colors text-center font-medium" placeholder="Sua senha atual">
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="app.closeDeleteModal()" class="flex-1 py-2.5 rounded-lg border border-slate-600 text-slate-300 hover:bg-slate-800 transition-colors font-medium">Cancelar</button>
                    <button type="submit" id="btnConfirmDelete" class="flex-1 py-2.5 bg-red-600 hover:bg-red-500 text-white rounded-lg shadow-lg font-medium transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-trash"></i> Excluir Tudo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const app = {
            async init() {
                await this.loadProfile();
                this.setupListeners();
            },

            setupListeners() {
                document.getElementById('profileForm').addEventListener('submit', (e) => this.saveProfile(e));
            },

            showToast(message, type = 'success') {
                let toast = document.getElementById('gluon-toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'gluon-toast';
                    document.body.appendChild(toast);
                }
                
                const icon = type === 'success' ? '<i class="fa-solid fa-circle-check"></i>' : '<i class="fa-solid fa-circle-exclamation"></i>';
                const bgClass = type === 'success' ? 'bg-green-600' : 'bg-red-600';
                
                toast.className = `fixed bottom-6 right-6 px-5 py-3 rounded-lg shadow-xl text-white text-sm font-medium flex items-center gap-3 z-50 transition-all duration-300 transform translate-y-10 opacity-0 ${bgClass}`;
                toast.innerHTML = `${icon} <span>${message}</span>`;
                
                setTimeout(() => {
                    toast.classList.remove('translate-y-10', 'opacity-0');
                    toast.classList.add('translate-y-0', 'opacity-100');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-10', 'opacity-0');
                }, 4000);
            },

            async api(endpoint, action, payload = {}) {
                payload.action = action;
                try {
                    const res = await fetch(`/api/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (res.status === 401) window.location.href = '/';
                    const data = await res.json();
                    if (data.status !== 'success') throw new Error(data.message);
                    return data;
                } catch (err) {
                    this.showToast(err.message || 'Erro de conexão.', 'error');
                    return null;
                }
            },

            async loadProfile() {
                const res = await this.api('user', 'get_profile');
                if (res && res.data) {
                    document.getElementById('username').value = res.data.username;
                    document.getElementById('email').value = res.data.email;
                }
            },

            async saveProfile(e) {
                e.preventDefault();
                const btn = document.getElementById('btnSaveProfile');
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Salvando...';
                btn.disabled = true;

                const payload = {
                    username: document.getElementById('username').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    new_password: document.getElementById('new_password').value,
                    current_password: document.getElementById('current_password').value
                };

                const res = await this.api('user', 'update_profile', payload);
                
                if (res) {
                    this.showToast(res.message, 'success');
                    document.getElementById('current_password').value = '';
                    document.getElementById('new_password').value = '';
                }
                
                btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> <span>Salvar Alterações</span>';
                btn.disabled = false;
            },

            async logout() {
                const btn = document.getElementById('btnLogout');
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Saindo...';
                
                const res = await this.api('auth', 'logout');
                if (res) window.location.href = '/';
            },

            openDeleteModal() {
                const modal = document.getElementById('deleteModal');
                const content = document.getElementById('deleteModalContent');
                document.getElementById('delete_password').value = '';
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    document.getElementById('delete_password').focus();
                }, 10);
            },

            closeDeleteModal() {
                const modal = document.getElementById('deleteModal');
                const content = document.getElementById('deleteModalContent');
                
                modal.classList.add('opacity-0');
                content.classList.add('scale-95');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 300);
            },

            async deleteAccount(e) {
                e.preventDefault();
                const btn = document.getElementById('btnConfirmDelete');
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Excluindo...';
                btn.disabled = true;

                const payload = {
                    password: document.getElementById('delete_password').value
                };

                const res = await this.api('user', 'delete_account', payload);
                
                if (res) {
                    this.showToast('Conta excluída com sucesso. Redirecionando...', 'success');
                    setTimeout(() => window.location.href = '/', 1500);
                } else {
                    btn.innerHTML = '<i class="fa-solid fa-trash"></i> Excluir Tudo';
                    btn.disabled = false;
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
