<!-- 
  Arquivo: dashboard.html
  Diretório: public_html/gluon/views/dashboard.html
  
  Pilar: Fácil Manutenção, Bonito e Rápido.
  Atualização: Remoção do botão de configuração redundante (ícone de engrenagem) ao final do breadcrumb, 
               centralizando a ação no menu de contexto (3 pontinhos).
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gluon - Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gluon: { dark: '#0f172a', primary: '#3b82f6', secondary: '#1e293b', accent: '#6366f1' }
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .dir-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .dir-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .kanban-scroll::-webkit-scrollbar { width: 4px; }
        .kanban-scroll::-webkit-scrollbar-track { background: transparent; }
        .kanban-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        .view-radio:checked + div { background-color: #3b82f6; border-color: #3b82f6; color: white; }
        .icon-radio:checked + div { background-color: #1e293b; border-color: #3b82f6; color: #3b82f6; }

        .reorder-active .draggable-item { border-color: #22c55e !important; box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.1); }
        .reorder-active .draggable-item, .reorder-active .kanban-col-handle, .reorder-active .kanban-item { cursor: grab !important; }
        .reorder-active .draggable-item:active, .reorder-active .kanban-col-handle:active, .reorder-active .kanban-item:active { cursor: grabbing !important; }
        .reorder-active .kanban-item { border-color: #22c55e !important; background-color: #1e293b !important; }
        .reorder-active .grip-handle { display: inline-block !important; }
        .reorder-active .cog-btn { display: none !important; }
        .kanban-scroll .kanban-empty:not(:only-child) { display: none !important; }
        .reorder-active.snap-x { scroll-snap-type: none !important; }
        .reorder-active .snap-start { scroll-snap-align: none !important; }
        .sortable-ghost { opacity: 0.3; background-color: #1e293b !important; border: 2px dashed #22c55e !important; }
        .sortable-drag { opacity: 1 !important; cursor: grabbing !important; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5) !important; }

        .icon-gradient {
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 40px;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gluon-dark text-slate-200 min-h-screen flex flex-col font-sans selection:bg-gluon-primary selection:text-white relative">

    <!-- Top Navigation -->
    <nav class="bg-gluon-secondary border-b border-slate-700/50 sticky top-0 z-40 backdrop-blur-md bg-opacity-90">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-slate-800 border border-slate-600 flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-atom text-xl text-gluon-primary"></i>
                </div>
                <span class="font-bold text-xl tracking-wide text-white">GLUON</span>
            </div>
            
            <div class="flex items-center gap-2 sm:gap-4">
                <button onclick="app.toggleReorderMode()" id="btn-reorder-desktop" class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg border border-transparent font-medium text-sm transition-all text-slate-400 hover:text-white hover:bg-slate-700" title="Ativar Modo de Reordenação">
                    <i class="fa-solid fa-arrow-right-arrow-left fa-rotate-90"></i>
                    <span>Ordem</span>
                </button>

                <div class="hidden md:block w-px h-6 bg-slate-700 mx-1"></div>

                <div class="hidden md:flex items-center gap-1 bg-slate-800 rounded-lg p-1 border border-slate-700">
                    <button onclick="app.setViewMode('grid')" id="btn-view-grid" class="view-btn px-3 py-1.5 rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-colors" title="Grid"><i class="fa-solid fa-border-all"></i></button>
                    <button onclick="app.setViewMode('list')" id="btn-view-list" class="view-btn px-3 py-1.5 rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-colors" title="Lista"><i class="fa-solid fa-list-ul"></i></button>
                    <button onclick="app.setViewMode('kanban')" id="btn-view-kanban" class="view-btn px-3 py-1.5 rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-colors" title="Kanban"><i class="fa-solid fa-columns"></i></button>
                </div>

                <!-- Menu de Opções Geral (3 pontinhos) - Agora visível também no desktop -->
                <div class="relative">
                    <button onclick="app.toggleMobileViewMenu()" id="btn-mobile-menu-trigger" class="text-slate-400 hover:text-white p-2 rounded-lg hover:bg-slate-800 transition-colors outline-none focus:ring-2 focus:ring-slate-700">
                        <i class="fa-solid fa-ellipsis-vertical px-1"></i>
                    </button>
                    <div id="mobileViewMenu" class="hidden absolute right-0 top-12 w-56 bg-slate-800 border border-slate-700 rounded-xl shadow-2xl py-2 z-50 origin-top-right transition-all">
                        
                        <!-- Opções de Pasta Atual -->
                        <div class="px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Ações do Diretório</div>
                        
                        <!-- Configurar Pasta Atual (Nova adição utilitária) -->
                        <button onclick="app.openModal(app.getCurrentParentId() || 'root'); app.toggleMobileViewMenu()" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-3 transition-colors">
                            <i class="fa-solid fa-folder-gear w-5 text-center text-lg"></i> <span class="font-medium">Configurações</span>
                        </button>

                        <!-- NOVO: Botão Copiar (Visibilidade controlada pelo JS) -->
                        <button onclick="app.copyCurrentDirectory(); app.toggleMobileViewMenu()" id="btn-copy-dir" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-3 transition-colors">
                            <i class="fa-regular fa-copy w-5 text-center text-lg"></i> <span class="font-medium">Copiar Diretório</span>
                        </button>

                        <div class="h-px bg-slate-700/50 my-2 md:hidden"></div>

                        <!-- Opções exclusivas do Mobile (Ocultas no Desktop) -->
                        <div class="md:hidden">
                            <button onclick="app.toggleReorderMode(); app.toggleMobileViewMenu()" id="btn-reorder-mobile" class="w-full text-left px-4 py-3 text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-3 transition-colors border-b border-slate-700/50 mb-1">
                                <i class="fa-solid fa-arrow-right-arrow-left fa-rotate-90 w-5 text-center text-lg"></i> <span class="font-medium">Alterar Ordem</span>
                            </button>
                            <div class="px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Visualização</div>
                            <button onclick="app.setViewMode('grid'); app.toggleMobileViewMenu()" id="btn-mobile-view-grid" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-3 transition-colors"><i class="fa-solid fa-border-all w-5 text-center text-lg"></i> <span class="font-medium">Grid</span></button>
                            <button onclick="app.setViewMode('list'); app.toggleMobileViewMenu()" id="btn-mobile-view-list" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-3 transition-colors"><i class="fa-solid fa-list-ul w-5 text-center text-lg"></i> <span class="font-medium">Lista</span></button>
                            <button onclick="app.setViewMode('kanban'); app.toggleMobileViewMenu()" id="btn-mobile-view-kanban" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-3 transition-colors"><i class="fa-solid fa-columns w-5 text-center text-lg"></i> <span class="font-medium">Kanban</span></button>
                        </div>
                    </div>
                </div>
                
                <div class="h-6 w-px bg-slate-700"></div>
                <button onclick="window.location.href='/api/auth?action=logout'" class="text-sm text-slate-400 hover:text-red-400 transition-colors flex items-center gap-2"><i class="fa-solid fa-power-off"></i> <span class="hidden sm:inline">Sair</span></button>
            </div>
        </div>
    </nav>

    <!-- Main Workspace -->
    <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 flex flex-col h-[calc(100vh-64px)] overflow-hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 shrink-0">
            <div class="block text-sm text-slate-300 font-medium w-full flex-1 leading-relaxed break-words" id="breadcrumbs"></div>
            
            <div id="reorder-hint" class="hidden animate-pulse text-green-400 text-sm font-medium flex-1 text-center bg-green-500/10 py-2 px-4 rounded-lg border border-green-500/20">
                <i class="fa-solid fa-hand-pointer mr-2"></i> Arraste os itens para reordenar
            </div>
            <button onclick="app.openModal()" class="w-full sm:w-auto shrink-0 bg-gluon-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg shadow-blue-500/20 transition-all flex items-center justify-center gap-2 font-medium">
                <i class="fa-solid fa-folder-plus"></i> Novo Diretório
            </button>
        </div>

        <div id="loader" class="hidden flex-1 flex flex-col items-center justify-center text-slate-500 gap-3">
            <i class="fa-solid fa-circle-notch fa-spin text-3xl text-gluon-primary"></i>
            <p>Sincronizando cofre...</p>
        </div>

        <div id="viewContainer" class="flex-1 overflow-y-auto no-scrollbar pb-10 transition-all"></div>
    </main>

    <!-- Modal com Abas -->
    <div id="dirModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 opacity-0 transition-opacity duration-300 px-4">
        <div class="bg-gluon-secondary border border-slate-700 rounded-xl shadow-2xl w-full max-w-md p-0 transform scale-95 transition-transform duration-300 overflow-hidden flex flex-col max-h-[90vh]" id="dirModalContent">
            
            <div class="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                <h3 class="text-xl font-semibold text-white flex items-center gap-2" id="modalTitle">
                    <i class="fa-solid fa-folder-gear text-gluon-primary"></i> <span>Configuração</span>
                </h3>
                <button onclick="app.closeModal()" class="text-slate-400 hover:text-white text-xl"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <!-- Modal Tabs -->
            <div class="flex border-b border-slate-700 bg-slate-900/30">
                <button type="button" onclick="app.switchModalTab('geral')" id="tab-btn-geral" class="flex-1 py-3 text-sm font-medium border-b-2 border-gluon-primary text-white transition-colors">Geral</button>
                <button type="button" onclick="app.switchModalTab('apar')" id="tab-btn-apar" class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-200 transition-colors">Aparência</button>
            </div>

            <form id="dirForm" onsubmit="app.saveDirectory(event)" class="flex flex-col flex-1 overflow-hidden">
                <input type="hidden" id="dirId">
                <input type="hidden" id="dirParentId">

                <!-- ABA GERAL -->
                <div id="tab-geral" class="p-6 overflow-y-auto flex-1">
                    <div id="dirNameContainer" class="mb-5">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Nome da Pasta</label>
                        <div class="relative">
                            <i class="fa-solid fa-pen absolute left-3 top-3.5 text-slate-500 text-sm"></i>
                            <textarea id="dirName" rows="1" autocomplete="off" class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2.5 pl-9 pr-3 text-white focus:outline-none focus:border-gluon-primary focus:ring-1 focus:ring-gluon-primary transition-all resize-none overflow-hidden min-h-[44px]"></textarea>
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="block text-sm font-medium text-slate-300 mb-2">Padrão de Visualização Interna</label>
                        <div class="grid grid-cols-3 gap-2 sm:gap-3">
                            <label class="cursor-pointer">
                                <input type="radio" name="dirViewMode" value="grid" class="peer hidden view-radio" checked>
                                <div class="border border-slate-600 bg-slate-800 text-slate-400 rounded-lg p-2 sm:p-3 text-center transition-all hover:bg-slate-700"><i class="fa-solid fa-border-all block text-xl mb-1"></i><span class="text-xs font-medium">Grid</span></div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="dirViewMode" value="list" class="peer hidden view-radio">
                                <div class="border border-slate-600 bg-slate-800 text-slate-400 rounded-lg p-2 sm:p-3 text-center transition-all hover:bg-slate-700"><i class="fa-solid fa-list-ul block text-xl mb-1"></i><span class="text-xs font-medium">Lista</span></div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="dirViewMode" value="kanban" class="peer hidden view-radio">
                                <div class="border border-slate-600 bg-slate-800 text-slate-400 rounded-lg p-2 sm:p-3 text-center transition-all hover:bg-slate-700"><i class="fa-solid fa-columns block text-xl mb-1"></i><span class="text-xs font-medium">Kanban</span></div>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Adicionar novos itens no:</label>
                        <div class="grid grid-cols-2 gap-2 sm:gap-3">
                            <label class="cursor-pointer">
                                <input type="radio" name="dirItemPosition" value="start" class="peer hidden view-radio">
                                <div class="border border-slate-600 bg-slate-800 text-slate-400 rounded-lg p-2 sm:p-3 text-center transition-all hover:bg-slate-700">
                                    <i class="fa-solid fa-arrow-up block text-xl mb-1"></i><span class="text-xs font-medium">Início da Lista</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="dirItemPosition" value="end" class="peer hidden view-radio" checked>
                                <div class="border border-slate-600 bg-slate-800 text-slate-400 rounded-lg p-2 sm:p-3 text-center transition-all hover:bg-slate-700">
                                    <i class="fa-solid fa-arrow-down block text-xl mb-1"></i><span class="text-xs font-medium">Final da Lista</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ABA APARÊNCIA -->
                <div id="tab-apar" class="hidden p-6 overflow-y-auto flex-1 space-y-5">
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1"><i class="fa-regular fa-image mr-1"></i> Imagem de Capa (Galeria)</label>
                        <input type="file" id="dirCoverFile" accept="image/*" class="w-full text-sm text-slate-400 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-white hover:file:bg-slate-600 transition-all cursor-pointer bg-slate-800 border border-slate-600 rounded-lg">
                        <input type="hidden" id="dirCoverBase64">
                        <div id="coverPreview" class="mt-3 hidden w-full h-24 rounded-lg bg-cover bg-center border border-slate-600 shadow-inner"></div>
                        <button type="button" id="btnRemoveCover" class="hidden mt-2 text-xs text-red-400 hover:text-red-300 flex items-center gap-1"><i class="fa-solid fa-trash"></i> Remover capa</button>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2"><i class="fa-solid fa-palette mr-1"></i> Cor do Ícone (Gradient)</label>
                        <div class="flex gap-4 items-center">
                            <div class="flex-1">
                                <span class="text-xs text-slate-500 block mb-1">Início</span>
                                <input type="color" id="dirColorFrom" value="#3b82f6" class="bg-slate-800 border border-slate-600">
                            </div>
                            <i class="fa-solid fa-arrow-right text-slate-500 mt-4"></i>
                            <div class="flex-1">
                                <span class="text-xs text-slate-500 block mb-1">Fim</span>
                                <input type="color" id="dirColorTo" value="#6366f1" class="bg-slate-800 border border-slate-600">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2"><i class="fa-solid fa-icons mr-1"></i> Selecionar Ícone</label>
                        <div class="grid grid-cols-5 gap-2 max-h-40 overflow-y-auto no-scrollbar p-1" id="icon-picker">
                            <!-- Injetado via JS -->
                        </div>
                    </div>
                </div>

                <!-- Footer do Modal -->
                <div class="p-5 border-t border-slate-700 bg-slate-800/50 flex flex-col-reverse sm:flex-row justify-between items-center gap-3 shrink-0">
                    <div class="w-full sm:w-auto">
                        <button type="button" id="btnDeleteDir" onclick="app.deleteFromModal()" class="hidden w-full text-red-400 hover:text-white hover:bg-red-500/20 px-3 py-2 rounded-lg transition-colors flex justify-center items-center gap-2 text-sm">
                            <i class="fa-solid fa-trash"></i> <span>Excluir</span>
                        </button>
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto justify-end">
                        <button type="button" onclick="app.closeModal()" class="px-4 py-2 rounded-lg text-slate-300 hover:bg-slate-700 transition-colors text-sm font-medium">Cancelar</button>
                        <button type="submit" id="btnSaveDir" class="px-4 py-2 bg-gluon-primary hover:bg-blue-600 text-white rounded-lg shadow-lg flex items-center gap-2 text-sm font-medium transition-all">
                            <i class="fa-solid fa-check"></i> Salvar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const app = {
            state: {
                path: [{ id: null, name: 'Meu Cofre', view: 'grid' }],
                directories: [],
                directoryCache: new Map(), 
                rootPrefs: { view: 'grid', new_item_position: 'end' }, 
                isLoading: false,
                reorderMode: false,
                availableIcons: [
                    'fa-folder', 'fa-folder-open', 'fa-star', 'fa-heart', 'fa-file', 'fa-image', 'fa-music', 'fa-video', 
                    'fa-code', 'fa-lock', 'fa-vault', 'fa-book', 'fa-briefcase', 'fa-camera', 'fa-gamepad', 'fa-globe',
                    'fa-key', 'fa-layer-group', 'fa-cube', 'fa-rocket'
                ]
            },
            
            sortableInstances: [],

            async init() {
                this.renderIconPicker();
                this.setLoading(true);
                await this.fetchUserPrefs(); 
                this.updateTopButtons();
                await this.fetchDirectories();
                this.setupEventListeners();
            },

            setupEventListeners() {
                document.addEventListener('click', (event) => {
                    const menu = document.getElementById('mobileViewMenu');
                    const trigger = document.getElementById('btn-mobile-menu-trigger');
                    if (menu && !menu.classList.contains('hidden') && !menu.contains(event.target) && !trigger.contains(event.target)) {
                        menu.classList.add('hidden');
                    }
                });

                document.getElementById('dirCoverFile').addEventListener('change', (e) => this.handleCoverUpload(e));
                document.getElementById('btnRemoveCover').addEventListener('click', () => this.removeCover());
                
                const dirNameInput = document.getElementById('dirName');
                if (dirNameInput) {
                    dirNameInput.addEventListener('input', function() {
                        this.style.height = 'auto'; 
                        this.style.height = (this.scrollHeight) + 'px'; 
                    });
                    
                    dirNameInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault(); 
                            app.saveDirectory(e); 
                        }
                    });
                }
            },

            // Sistema de Toast UI (Rápido e Bonito)
            showToast(message, type = 'success') {
                let toast = document.getElementById('gluon-toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'gluon-toast';
                    document.body.appendChild(toast);
                }
                
                const icon = type === 'success' ? '<i class="fa-solid fa-circle-check"></i>' : '<i class="fa-solid fa-circle-exclamation"></i>';
                const bgClass = type === 'success' ? 'bg-green-600' : 'bg-red-600';
                
                toast.className = `fixed bottom-6 right-6 px-5 py-3 rounded-lg shadow-xl text-white text-sm font-medium flex items-center gap-3 z-50 transition-all duration-300 transform translate-y-10 opacity-0 ${bgClass}`;
                toast.innerHTML = `${icon} <span>${message}</span>`;
                
                // Trigger animation
                setTimeout(() => {
                    toast.classList.remove('translate-y-10', 'opacity-0');
                    toast.classList.add('translate-y-0', 'opacity-100');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-10', 'opacity-0');
                }, 3000);
            },

            // Nova Função: Copiar Diretório (Área de Transferência)
            async copyCurrentDirectory() {
                const currentId = this.getCurrentParentId();
                if (currentId === null) return; // Segurança extra

                const response = await this.api('user', 'copy_directory', { dir_id: currentId });
                if (response && response.status === 'success') {
                    this.showToast(response.message, 'success');
                } else {
                    this.showToast(response ? response.message : 'Erro ao copiar', 'error');
                }
            },

            handleCoverUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600; const MAX_HEIGHT = 400;
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }

                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        
                        const base64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('dirCoverBase64').value = base64;
                        
                        const preview = document.getElementById('coverPreview');
                        preview.style.backgroundImage = `url('${base64}')`;
                        preview.classList.remove('hidden');
                        document.getElementById('btnRemoveCover').classList.remove('hidden');
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            },

            removeCover() {
                document.getElementById('dirCoverFile').value = '';
                document.getElementById('dirCoverBase64').value = '';
                const preview = document.getElementById('coverPreview');
                if (preview) { preview.classList.add('hidden'); preview.style.backgroundImage = 'none'; }
                const btn = document.getElementById('btnRemoveCover');
                if (btn) btn.classList.add('hidden');
            },

            renderIconPicker() {
                const container = document.getElementById('icon-picker');
                container.innerHTML = this.state.availableIcons.map(icon => `
                    <label class="cursor-pointer">
                        <input type="radio" name="dirIcon" value="${icon}" class="peer hidden icon-radio" ${icon === 'fa-folder' ? 'checked' : ''}>
                        <div class="border border-slate-600 bg-slate-800 text-slate-400 rounded-lg p-2 flex items-center justify-center transition-all hover:bg-slate-700 hover:text-white h-10">
                            <i class="fa-solid ${icon} text-lg"></i>
                        </div>
                    </label>
                `).join('');
            },

            getCurrentParentId() { return this.state.path[this.state.path.length - 1].id; },
            getCurrentView() { return this.state.path[this.state.path.length - 1].view; },

            async api(endpoint, action, payload = {}) {
                payload.action = action;
                try {
                    const res = await fetch(`/api/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (res.status === 401) window.location.href = '/'; 
                    const data = await res.json();
                    if (data.status !== 'success') throw new Error(data.message);
                    return data;
                } catch (err) { console.error('Erro:', err.message); return null; }
            },

            async fetchUserPrefs() {
                const response = await this.api('user', 'get_prefs');
                if (response && response.data) {
                    this.state.rootPrefs = {
                        view: response.data.root_view || 'grid',
                        new_item_position: response.data.root_new_item_position || 'end'
                    };
                    this.state.path[0].view = this.state.rootPrefs.view;
                }
            },

            async fetchDirectories() {
                this.setLoading(true);
                this.renderBreadcrumbs();
                this.updateTopButtons();
                const response = await this.api('directories', 'fetch', { parent_id: this.getCurrentParentId() });
                if (response) { 
                    this.state.directories = response.data; 
                    response.data.forEach(d => this.state.directoryCache.set(Number(d.id), d));
                    this.render(); 
                }
                this.setLoading(false);
            },

            async enterDirectory(id, name, viewMode) {
                if(this.state.reorderMode) return; 
                this.state.path.push({ id, name, view: viewMode });
                if (this.state.reorderMode) this.toggleReorderMode();
                await this.fetchDirectories();
            },

            async goUpTo(index) {
                this.state.path = this.state.path.slice(0, index + 1);
                if (this.state.reorderMode) this.toggleReorderMode();
                await this.fetchDirectories();
            },

            renderBreadcrumbs() {
                const container = document.getElementById('breadcrumbs');
                
                container.innerHTML = this.state.path.map((step, index) => {
                    const isLast = index === this.state.path.length - 1;
                    const color = isLast ? 'text-white font-semibold' : 'text-slate-400 hover:text-gluon-primary transition-colors';
                    const separator = isLast ? '' : ' <i class="fa-solid fa-chevron-right text-[10px] text-slate-600 mx-1"></i> ';

                    return `<span class="inline" ${!isLast ? `onclick="app.goUpTo(${index})"` : ''}>
                        <span class="${color} ${!isLast ? 'cursor-pointer hover:underline' : ''} transition-colors">
                            ${index === 0 ? '<i class="fa-solid fa-vault mr-1"></i>' : ''}${step.name}
                        </span>${separator}
                    </span>`;
                }).join('');
            },

            toggleMobileViewMenu() { document.getElementById('mobileViewMenu').classList.toggle('hidden'); },

            async setViewMode(viewName) {
                this.state.path[this.state.path.length - 1].view = viewName;
                this.updateTopButtons();
                this.render();
                if (this.getCurrentParentId() === null) {
                    this.state.rootPrefs.view = viewName;
                    this.api('user', 'update_root_prefs', this.state.rootPrefs);
                }
            },

            toggleReorderMode() {
                this.state.reorderMode = !this.state.reorderMode;
                const btnDesk = document.getElementById('btn-reorder-desktop');
                const btnMob = document.getElementById('btn-reorder-mobile');
                const container = document.getElementById('viewContainer');
                const wrapper = document.getElementById('sortable-wrapper');
                const hint = document.getElementById('reorder-hint');

                if(this.state.reorderMode) {
                    btnDesk.classList.add('bg-green-600', 'text-white', 'border-green-500', 'shadow-lg', 'shadow-green-500/20'); btnDesk.classList.remove('text-slate-400', 'hover:bg-slate-700');
                    if(btnMob) { btnMob.classList.add('text-green-400', 'bg-slate-700/50'); btnMob.classList.remove('text-slate-300'); }
                    container.classList.add('reorder-active'); if(wrapper) wrapper.classList.add('reorder-active'); hint.classList.remove('hidden');
                } else {
                    btnDesk.classList.remove('bg-green-600', 'text-white', 'border-green-500', 'shadow-lg', 'shadow-green-500/20'); btnDesk.classList.add('text-slate-400', 'hover:bg-slate-700');
                    if(btnMob) { btnMob.classList.remove('text-green-400', 'bg-slate-700/50'); btnMob.classList.add('text-slate-300'); }
                    container.classList.remove('reorder-active'); if(wrapper) wrapper.classList.remove('reorder-active'); hint.classList.add('hidden');
                }
                this.initSortable();
            },

            initSortable() {
                if (this.sortableInstances.length > 0) { this.sortableInstances.forEach(inst => inst.destroy()); this.sortableInstances = []; }
                if (!this.state.reorderMode) return;
                const wrapper = document.getElementById('sortable-wrapper');
                const currentView = this.getCurrentView();

                if (wrapper) {
                    this.sortableInstances.push(new Sortable(wrapper, {
                        animation: 250, delay: 150, delayOnTouchOnly: true, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', forceFallback: true, fallbackOnBody: true, scroll: true, scrollSensitivity: 80, scrollSpeed: 15,       
                        direction: currentView === 'kanban' ? 'horizontal' : (currentView === 'list' ? 'vertical' : undefined),
                        handle: currentView === 'kanban' ? '.kanban-col-handle' : undefined,
                        onEnd: () => this.saveNewOrder()
                    }));
                }

                if (currentView === 'kanban') {
                    document.querySelectorAll('.kanban-scroll').forEach(col => {
                        this.sortableInstances.push(new Sortable(col, {
                            group: 'kanban-items', animation: 250, delay: 150, delayOnTouchOnly: true, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', forceFallback: true, fallbackOnBody: true, scroll: true, scrollSensitivity: 60, scrollSpeed: 15,
                            onEnd: (evt) => {
                                const toId = evt.to.getAttribute('data-parent-id');
                                const fromId = evt.from.getAttribute('data-parent-id');
                                this.saveInnerOrder(evt.to, toId);
                                if (evt.to !== evt.from) this.saveInnerOrder(evt.from, fromId);
                            }
                        }));
                    });
                }
            },

            async saveNewOrder() {
                const wrapper = document.getElementById('sortable-wrapper');
                if (!wrapper) return;
                const orderIds = Array.from(wrapper.children).map(item => item.getAttribute('data-id')).filter(id => id !== null);
                this.state.directories = orderIds.map(id => this.state.directories.find(d => d.id == id)).filter(Boolean);
                await this.api('directories', 'reorder', { order: orderIds });
            },

            async saveInnerOrder(columnEl, newParentId) {
                if (!columnEl) return;
                const orderIds = Array.from(columnEl.querySelectorAll('.kanban-item')).map(item => item.getAttribute('data-id')).filter(id => id !== null);
                await this.api('directories', 'reorder', { order: orderIds, parent_id: newParentId ? parseInt(newParentId) : null });
            },

            updateTopButtons() {
                const currentView = this.getCurrentView();
                ['grid', 'list', 'kanban'].forEach(v => {
                    const btn = document.getElementById(`btn-view-${v}`);
                    if(btn) { btn.className = btn.className.replace(/text-slate-400|bg-slate-700|text-white/g, ''); btn.classList.add(v === currentView ? 'bg-slate-700' : 'text-slate-400'); if(v === currentView) btn.classList.add('text-white'); }
                    const mBtn = document.getElementById(`btn-mobile-view-${v}`);
                    if(mBtn) { mBtn.className = mBtn.className.replace(/text-slate-300|text-gluon-primary|bg-slate-700\/50/g, ''); mBtn.classList.add(v === currentView ? 'text-gluon-primary' : 'text-slate-300'); if(v === currentView) mBtn.classList.add('bg-slate-700/50'); }
                });

                // Regra de Visibilidade do botão de COPIAR e Configurar Pasta
                const btnCopy = document.getElementById('btn-copy-dir');
                if (btnCopy) {
                    if (this.getCurrentParentId() === null) {
                        // Se estiver na raiz, esconde o botão de copiar
                        btnCopy.classList.add('hidden');
                        btnCopy.classList.remove('flex');
                    } else {
                        // Se estiver dentro de uma pasta, mostra o botão
                        btnCopy.classList.remove('hidden');
                        btnCopy.classList.add('flex');
                    }
                }
            },

            switchModalTab(tabName) {
                const tGeral = document.getElementById('tab-geral');
                const tApar = document.getElementById('tab-apar');
                const bGeral = document.getElementById('tab-btn-geral');
                const bApar = document.getElementById('tab-btn-apar');

                if(tabName === 'geral') {
                    tGeral.classList.remove('hidden'); tApar.classList.add('hidden');
                    bGeral.classList.add('border-gluon-primary', 'text-white'); bGeral.classList.remove('border-transparent', 'text-slate-400');
                    bApar.classList.add('border-transparent', 'text-slate-400'); bApar.classList.remove('border-gluon-primary', 'text-white');
                } else {
                    tApar.classList.remove('hidden'); tGeral.classList.add('hidden');
                    bApar.classList.add('border-gluon-primary', 'text-white'); bApar.classList.remove('border-transparent', 'text-slate-400');
                    bGeral.classList.add('border-transparent', 'text-slate-400'); bGeral.classList.remove('border-gluon-primary', 'text-white');
                }
            },

            openModal(id = '', name = '', targetParentId = null, currentViewMode = 'grid') {
                if(this.state.reorderMode) return; 

                this.switchModalTab('geral');
                document.getElementById('dirId').value = id;
                document.getElementById('dirParentId').value = targetParentId !== null ? targetParentId : '';
                
                let dirObj = null;
                const isRootSettings = id === 'root';
                const dirNameInput = document.getElementById('dirName');

                if (isRootSettings) {
                    dirObj = { name: 'Meu Cofre (Raiz)', view: this.state.rootPrefs.view, new_item_position: this.state.rootPrefs.new_item_position };
                    document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-vault text-gluon-primary"></i> <span>Configurar Raiz</span>';
                    document.getElementById('dirNameContainer').classList.add('hidden');
                    document.getElementById('tab-btn-apar').classList.add('hidden');
                } else if (id) {
                    dirObj = this.state.directoryCache.get(Number(id));
                    document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-folder-gear text-gluon-primary"></i> <span>Configurar Pasta</span>';
                    document.getElementById('dirNameContainer').classList.remove('hidden');
                    document.getElementById('tab-btn-apar').classList.remove('hidden');
                } else {
                    document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-folder-plus text-gluon-primary"></i> <span>Nova Pasta</span>';
                    document.getElementById('dirNameContainer').classList.remove('hidden');
                    document.getElementById('tab-btn-apar').classList.remove('hidden');
                }

                dirNameInput.value = dirObj ? dirObj.name : name;

                this.removeCover();
                if (dirObj && dirObj.cover_url) {
                    document.getElementById('dirCoverBase64').value = dirObj.cover_url;
                    document.getElementById('coverPreview').style.backgroundImage = `url('${dirObj.cover_url}')`;
                    document.getElementById('coverPreview').classList.remove('hidden');
                    document.getElementById('btnRemoveCover').classList.remove('hidden');
                }

                document.getElementById('dirColorFrom').value = (dirObj && dirObj.color_from) ? dirObj.color_from : '#3b82f6';
                document.getElementById('dirColorTo').value = (dirObj && dirObj.color_to) ? dirObj.color_to : '#6366f1';
                
                const iconToSelect = (dirObj && dirObj.icon) ? dirObj.icon : 'fa-folder'; 
                const iconRadios = document.getElementsByName('dirIcon');
                for(let i=0; i<iconRadios.length; i++) { iconRadios[i].checked = (iconRadios[i].value === iconToSelect); }

                const posToSelect = (dirObj && dirObj.new_item_position) ? dirObj.new_item_position : 'end';
                const posRadios = document.getElementsByName('dirItemPosition');
                for(let i=0; i<posRadios.length; i++) { posRadios[i].checked = (posRadios[i].value === posToSelect); }

                const btnDelete = document.getElementById('btnDeleteDir');
                if(id && !isRootSettings) btnDelete.classList.remove('hidden'); else btnDelete.classList.add('hidden');

                const viewToSelect = (dirObj && dirObj.view) ? dirObj.view : currentViewMode;
                const viewRadios = document.getElementsByName('dirViewMode');
                for(let i=0; i<viewRadios.length; i++) { viewRadios[i].checked = (viewRadios[i].value === viewToSelect); }
                
                const modal = document.getElementById('dirModal');
                const content = document.getElementById('dirModalContent');
                modal.classList.remove('hidden'); modal.classList.add('flex');
                
                setTimeout(() => { 
                    modal.classList.remove('opacity-0'); 
                    content.classList.remove('scale-95'); 
                    
                    dirNameInput.style.height = 'auto';
                    if (dirNameInput.scrollHeight > 0) {
                        dirNameInput.style.height = dirNameInput.scrollHeight + 'px';
                    }

                    if(!id && !isRootSettings) dirNameInput.focus(); 
                }, 20);
            },

            closeModal() {
                const modal = document.getElementById('dirModal');
                const content = document.getElementById('dirModalContent');
                modal.classList.add('opacity-0'); content.classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); document.getElementById('dirForm').reset(); }, 300);
            },

            async saveDirectory(e) {
                if (e && e.preventDefault) e.preventDefault();
                
                const id = document.getElementById('dirId').value;
                const isRootSettings = id === 'root';
                
                if (!isRootSettings && !document.getElementById('dirName').value.trim()) {
                    return this.showToast("O nome da pasta é obrigatório.", "error");
                }

                let selectedView = 'grid';
                const viewRadios = document.getElementsByName('dirViewMode');
                for(let i=0; i<viewRadios.length; i++) { if(viewRadios[i].checked) selectedView = viewRadios[i].value; }

                let selectedPos = 'end';
                const posRadios = document.getElementsByName('dirItemPosition');
                for(let i=0; i<posRadios.length; i++) { if(posRadios[i].checked) selectedPos = posRadios[i].value; }

                const btn = document.getElementById('btnSaveDir');
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Salvando...';
                btn.disabled = true;

                let response;

                if (isRootSettings) {
                    this.state.rootPrefs.view = selectedView;
                    this.state.rootPrefs.new_item_position = selectedPos;
                    response = await this.api('user', 'update_root_prefs', this.state.rootPrefs);
                    if (this.state.path.length === 1) {
                        this.state.path[0].view = selectedView;
                        this.updateTopButtons();
                    }
                } else {
                    let selectedIcon = 'fa-folder';
                    const iconRadios = document.getElementsByName('dirIcon');
                    for(let i=0; i<iconRadios.length; i++) { if(iconRadios[i].checked) selectedIcon = iconRadios[i].value; }

                    const payload = {
                        id: id !== '' ? id : null,
                        parent_id: document.getElementById('dirParentId').value !== '' ? document.getElementById('dirParentId').value : this.getCurrentParentId(),
                        name: document.getElementById('dirName').value.trim(),
                        view: selectedView,
                        new_item_position: selectedPos,
                        cover_url: document.getElementById('dirCoverBase64').value,
                        color_from: document.getElementById('dirColorFrom').value || '#3b82f6',
                        color_to: document.getElementById('dirColorTo').value || '#6366f1',
                        icon: selectedIcon
                    };

                    response = await this.api('directories', id !== '' ? 'update' : 'create', payload);
                }

                if (response) { this.closeModal(); await this.fetchDirectories(); }
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Salvar'; btn.disabled = false;
            },

            async deleteFromModal() {
                const id = document.getElementById('dirId').value;
                const name = document.getElementById('dirName').value;
                if(!id || id === 'root') return;
                if(confirm(`Atenção: A pasta "${name}" e TODO o seu conteúdo serão apagados PERMANENTEMENTE.\nDeseja continuar?`)) {
                    const btn = document.getElementById('btnDeleteDir'); btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Excluindo...';
                    const response = await this.api('directories', 'delete', { id });
                    if(response) { this.closeModal(); await this.fetchDirectories(); }
                    btn.innerHTML = '<i class="fa-solid fa-trash"></i> <span>Excluir</span>';
                }
            },

            setLoading(show) {
                this.state.isLoading = show;
                document.getElementById('loader').classList.toggle('hidden', !show);
                document.getElementById('viewContainer').classList.toggle('hidden', show);
            },

            getGradientStyle(from, to) { return `background: linear-gradient(135deg, ${from}, ${to});`; },
            getTextGradientStyle(from, to) { return `background: -webkit-linear-gradient(135deg, ${from}, ${to}); -webkit-background-clip: text; -webkit-text-fill-color: transparent;`; },

            async loadKanbanContents() {
                const promises = this.state.directories.map(async (dir) => {
                    const res = await this.api('directories', 'fetch', { parent_id: dir.id });
                    const container = document.getElementById(`kanban-col-${dir.id}`);
                    if (!container) return;
                    
                    if (res && res.data && res.data.length > 0) {
                        res.data.forEach(d => this.state.directoryCache.set(Number(d.id), d));

                        container.innerHTML = res.data.map(sub => `
                            <div data-id="${sub.id}" class="kanban-item bg-slate-700 hover:bg-slate-600 border border-slate-600 p-2.5 rounded-lg cursor-pointer flex justify-between items-center group transition-colors shadow-sm mb-2 relative overflow-hidden" onclick="app.enterDirectory(${sub.id}, '${sub.name.replace(/'/g, "\\'")}', '${sub.view}')">
                                ${sub.cover_url ? `<div class="absolute inset-0 bg-cover bg-center opacity-10" style="background-image: url('${sub.cover_url}')"></div>` : ''}
                                <div class="flex items-center gap-2 truncate pr-2 relative z-10">
                                    <i class="fa-solid fa-grip-vertical text-green-500 hidden grip-handle mr-1"></i>
                                    <i class="fa-solid ${sub.icon} text-sm" style="${this.getTextGradientStyle(sub.color_from, sub.color_to)}"></i>
                                    <span class="text-sm text-slate-200 truncate font-medium">${sub.name}</span>
                                </div>
                                <button onclick="event.stopPropagation(); app.openModal(${sub.id}, '${sub.name.replace(/'/g, "\\'")}', ${dir.id}, '${sub.view}')" class="relative z-10 text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-500 rounded p-1 sm:opacity-0 group-hover:opacity-100 transition-all border border-slate-600 cog-btn"><i class="fa-solid fa-cog text-xs"></i></button>
                            </div>`).join('');
                    } else {
                        container.innerHTML = `<div class="kanban-empty text-center flex flex-col items-center justify-center text-slate-500 text-xs py-8 opacity-60 border-2 border-dashed border-slate-700 rounded-lg"><i class="fa-solid fa-box-open text-2xl mb-2"></i> Pasta vazia</div>`;
                    }
                });
                await Promise.all(promises);
                if (this.state.reorderMode) this.initSortable();
            },

            render() {
                const container = document.getElementById('viewContainer');
                const view = this.getCurrentView();
                
                if (this.state.directories.length === 0) {
                    container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-500 mt-20 px-4 text-center"><i class="fa-regular fa-folder-open text-5xl sm:text-6xl mb-4 opacity-50"></i><h2 class="text-lg sm:text-xl font-medium text-slate-400">Esta pasta está vazia</h2><p class="text-sm mt-2">Clique em "Novo Diretório" para começar.</p></div>`;
                    return;
                }

                let html = '';

                if (view === 'grid') {
                    html = `<div id="sortable-wrapper" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 sm:gap-4">`;
                    this.state.directories.forEach(dir => {
                        html += `
                        <div data-id="${dir.id}" class="dir-card draggable-item group bg-slate-800 border border-slate-700 rounded-xl flex flex-col items-center text-center cursor-pointer relative overflow-hidden min-h-[140px]" onclick="app.enterDirectory(${dir.id}, '${dir.name.replace(/'/g, "\\'")}', '${dir.view}')">
                            ${dir.cover_url ? `<div class="absolute inset-0 bg-cover bg-center transition-transform duration-500 group-hover:scale-110" style="background-image: url('${dir.cover_url}')"></div><div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/80 to-slate-900/40"></div>` : ''}
                            
                            <div class="absolute top-2 left-2 text-green-500 hidden grip-handle bg-slate-900/80 backdrop-blur rounded p-1 z-20"><i class="fa-solid fa-grip-vertical"></i></div>
                            <div class="absolute top-2 right-2 sm:opacity-0 group-hover:opacity-100 transition-opacity cog-btn z-20">
                                <button onclick="event.stopPropagation(); app.openModal(${dir.id}, '${dir.name.replace(/'/g, "\\'")}', null, '${dir.view}')" class="text-slate-400 hover:text-white bg-slate-900/80 backdrop-blur hover:bg-slate-700 rounded p-1.5 shadow-lg"><i class="fa-solid fa-cog"></i></button>
                            </div>
                            
                            <div class="relative z-10 flex flex-col items-center justify-center w-full h-full p-4 pt-6">
                                <i class="fa-solid ${dir.icon} text-4xl sm:text-5xl mb-3 drop-shadow-md sm:group-hover:scale-110 transition-transform" style="${this.getTextGradientStyle(dir.color_from, dir.color_to)}"></i>
                                <span class="text-xs sm:text-sm font-medium text-slate-200 w-full truncate px-1 drop-shadow-md">${dir.name}</span>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                } 
                
                else if (view === 'list') {
                    html = `<div class="bg-slate-800 rounded-xl border border-slate-700 overflow-x-auto"><table class="w-full text-left text-sm min-w-[300px]"><thead class="bg-slate-900/50 text-slate-400"><tr><th class="px-4 py-3 font-medium w-10 text-center hidden grip-handle">#</th><th class="px-4 sm:px-6 py-3 font-medium w-12"></th><th class="px-4 py-3 font-medium">Nome</th><th class="px-4 sm:px-6 py-3 font-medium text-right">Ações</th></tr></thead><tbody id="sortable-wrapper" class="divide-y divide-slate-700/50">`;
                    this.state.directories.forEach(dir => {
                        html += `
                        <tr data-id="${dir.id}" class="draggable-item hover:bg-slate-700/50 transition-colors group cursor-pointer border-l-2 border-transparent relative overflow-hidden" onclick="app.enterDirectory(${dir.id}, '${dir.name.replace(/'/g, "\\'")}', '${dir.view}')">
                            <td class="px-2 py-3 text-center hidden grip-handle text-green-500 bg-slate-900/20"><i class="fa-solid fa-grip-vertical"></i></td>
                            <td class="px-4 sm:px-6 py-3 sm:py-4 text-center">
                                ${dir.cover_url ? `<div class="w-8 h-8 rounded bg-cover bg-center border border-slate-600 inline-block shadow-sm" style="background-image: url('${dir.cover_url}')"></div>` : `<i class="fa-solid ${dir.icon} text-xl" style="${this.getTextGradientStyle(dir.color_from, dir.color_to)}"></i>`}
                            </td>
                            <td class="px-4 py-3 sm:py-4 font-medium text-slate-200">${dir.name}</td>
                            <td class="px-4 sm:px-6 py-3 sm:py-4 text-right">
                                <div class="sm:opacity-0 group-hover:opacity-100 transition-opacity flex justify-end gap-2 cog-btn">
                                    <button onclick="event.stopPropagation(); app.openModal(${dir.id}, '${dir.name.replace(/'/g, "\\'")}', null, '${dir.view}')" class="text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-600 border border-slate-600 rounded p-2 text-xs sm:text-sm shadow"><i class="fa-solid fa-cog"></i> <span class="hidden sm:inline">Editar</span></button>
                                </div>
                            </td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                }

                else if (view === 'kanban') {
                    html = `<div id="sortable-wrapper" class="flex gap-4 sm:gap-6 overflow-x-auto pb-4 no-scrollbar h-full items-start snap-x">`;
                    this.state.directories.forEach(dir => {
                        html += `
                        <div data-id="${dir.id}" class="draggable-item snap-start bg-slate-800 border border-slate-700 rounded-xl w-[280px] sm:w-80 shrink-0 flex flex-col max-h-full shadow-lg relative transition-colors overflow-hidden">
                            <div class="p-4 border-b border-slate-700 flex justify-between items-center rounded-t-xl group cursor-pointer hover:bg-slate-700/50 transition-colors kanban-col-handle relative overflow-hidden min-h-[60px]" onclick="app.enterDirectory(${dir.id}, '${dir.name.replace(/'/g, "\\'")}', '${dir.view}')">
                                ${dir.cover_url ? `<div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${dir.cover_url}')"></div><div class="absolute inset-0 bg-slate-900/80 backdrop-blur-[2px]"></div>` : `<div class="absolute inset-0 bg-slate-900/50"></div>`}
                                
                                <div class="flex items-center gap-2 font-semibold text-slate-100 truncate w-full relative z-10 drop-shadow-md">
                                    <i class="fa-solid fa-grip-vertical text-green-500 hidden grip-handle mr-1"></i>
                                    <i class="fa-solid ${dir.icon} text-lg" style="${this.getTextGradientStyle(dir.color_from, dir.color_to)}"></i>
                                    <span class="truncate text-sm sm:text-base">${dir.name}</span>
                                </div>
                                <div class="flex gap-1 sm:opacity-0 group-hover:opacity-100 transition-opacity cog-btn relative z-10">
                                    <button onclick="event.stopPropagation(); app.openModal(${dir.id}, '${dir.name.replace(/'/g, "\\'")}', null, '${dir.view}')" class="text-slate-300 hover:text-white bg-slate-800/80 backdrop-blur hover:bg-slate-600 rounded p-1.5 shadow"><i class="fa-solid fa-cog text-xs"></i></button>
                                </div>
                            </div>
                            
                            <div class="p-3 flex-1 overflow-y-auto kanban-scroll" id="kanban-col-${dir.id}" data-parent-id="${dir.id}">
                                <div class="flex justify-center py-6"><i class="fa-solid fa-circle-notch fa-spin text-slate-500 text-2xl"></i></div>
                            </div>
                            
                            <div class="p-3 border-t border-slate-700 bg-slate-900/30 rounded-b-xl z-10 relative">
                                <button onclick="app.openModal('', '', ${dir.id}, 'grid')" class="text-slate-400 hover:text-white flex items-center justify-center gap-2 text-xs sm:text-sm transition-colors w-full py-2 hover:bg-slate-700 rounded-lg border border-slate-700/50 border-dashed">
                                    <i class="fa-solid fa-plus"></i> Nova pasta aqui
                                </button>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                    setTimeout(() => this.loadKanbanContents(), 0);
                }

                container.innerHTML = html;
                if (this.state.reorderMode) { document.getElementById('sortable-wrapper').classList.add('reorder-active'); this.initSortable(); }
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
